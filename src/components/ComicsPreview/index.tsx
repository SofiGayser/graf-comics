'use client';
import { reverseMap } from '@/constants';
import { ctx } from '@/context/contextProvider';
import { useTheme } from '@/context/themeProvider';
import { IComicsComment } from '@/store/comics/types';
import cn from 'classnames';
import { useRouter } from 'next/navigation';
import { FC, useContext, useEffect, useState } from 'react';
import { Chapters, SliderPreview, Tabs } from '../UI';
import { ComicsComment, FilterBarComponent, SimilarComics } from './components';
import { comicsData, comments } from './data';
import styles from './index.module.scss';
import { ComicsPreviewProps } from './types';

const ComicsPreview: FC<ComicsPreviewProps> = ({ comics = comicsData, isBackend = false }) => {
  const { setActiveBookMarks, setCurrentComicsId } = useContext(ctx);
  const { banner, covers, description, genres, title, toms, author, status, rating, id } = comics;

  const likes = comics?.likes || comicsData['likes'];
  const handleOpenBookmarks = () => {
    setCurrentComicsId(id);
    setActiveBookMarks(true);
  };
  const { theme } = useTheme();
  const [newCommentText, setNewCommentText] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const [isVisibleMore, setIsVisibleMore] = useState<boolean>(false);
  const [comicsStats, setComicsStats] = useState({
    views: 0,
    likes: likes.length,
    bookmarks: 0,
  });
  const [comicsComments, setComicsComments] = useState<IComicsComment[]>([]);

  const router = useRouter();

  //—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  const [commentsRender, setCommentsRender] = useState(comments);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [sortBy, setSortBy] = useState('newest');
  const [isBookmarkPopupOpen, setIsBookmarkPopupOpen] = useState(false);
  const [selectedStatus, setSelectedStatus] = useState('PLANNED');
  const handleAddToBookmark = async (status: string) => {
    try {
      const response = await fetch(`/api/comics/${id}/bookmark`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status }),
      });

      if (response.ok) {
        console.log(`–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ "${status}"`);
        setIsBookmarkPopupOpen(false);
        // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      } else {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∑–∞–∫–ª–∞–¥–∫–∏');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∑–∞–∫–ª–∞–¥–∫–∏:', error);
    }
  };

  const bookmarkOptions = [
    { value: 'READING', label: '–ß–∏—Ç–∞—é' },
    { value: 'PLANNED', label: '–í –ø–ª–∞–Ω–∞—Ö' },
    { value: 'COMPLETED', label: '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ' },
    { value: 'DROPPED', label: '–ë—Ä–æ—à–µ–Ω–æ' },
  ];
  // –û–ë–ù–û–í–õ–ï–ù–ù–´–ô: –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  useEffect(() => {
    const loadData = async () => {
      if (!id) return;

      try {
        console.log('üîÑ Loading data for comics:', id);

        // 1. –°–Ω–∞—á–∞–ª–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
        const viewResponse = await fetch(`/api/comics/${id}/view`, {
          method: 'POST',
        });

        if (viewResponse.ok) {
          const viewData = await viewResponse.json();
          console.log('‚úÖ View tracked:', viewData);
        } else {
          console.error('‚ùå View tracking failed');
        }

        // 2. –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const statsResponse = await fetch(`/api/comics/${id}/stats`);
        if (statsResponse.ok) {
          const statsData = await statsResponse.json();
          console.log('üìä Stats loaded:', statsData);
          setComicsStats(statsData);
        } else {
          console.error('‚ùå Stats loading failed');
          // Fallback –¥–∞–Ω–Ω—ã–µ
          setComicsStats({
            views: 1250,
            likes: likes.length,
            bookmarks: 42,
          });
        }

        // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        const commentsResponse = await fetch(`/api/comics/${id}/comments`);
        if (commentsResponse.ok) {
          const commentsData = await commentsResponse.json();
          setComicsComments(commentsData);
          setCommentsRender(commentsData);
        } else {
          setComicsComments(comments);
          setCommentsRender(comments);
        }
      } catch (error) {
        console.error('‚ùå Error loading data:', error);
        // Fallback –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        setComicsStats({
          views: 1250,
          likes: likes.length,
          bookmarks: 42,
        });
        setComicsComments(comments);
        setCommentsRender(comments);
      }
    };

    loadData();
  }, [id, likes]);

  const sortComments = (criteria: string, commentsRender: IComicsComment[]) => {
    const sorted = [...commentsRender];
    switch (criteria) {
      case 'new':
        sorted.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
        break;
      case 'oldest':
        sorted.sort((a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime());
        break;
      case 'popular':
        sorted.sort((a, b) => b.likes - a.likes);
        break;
      default:
        break;
    }

    setCommentsRender(sorted);
  };

  const handleSortSelect = (criteria: string) => {
    setSortBy(criteria);
    sortComments(criteria, commentsRender);
    setIsModalOpen(false);
  };

  function getSortBy() {
    switch (sortBy) {
      case 'new':
        return '–ù–æ–≤–æ–µ';
      case 'oldest':
        return '–°—Ç–∞—Ä–æ–µ';
      case 'popular':
        return '–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ';
      default:
        return '–ù–æ–≤–æ–µ';
    }
  }
  const handleSubmitComment = async () => {
    if (!newCommentText.trim() || isSubmitting) return;

    try {
      setIsSubmitting(true);

      const response = await fetch(`/api/comics/${id}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: newCommentText.trim(),
        }),
      });

      if (response.ok) {
        const newComment = await response.json();

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
        setComicsComments((prev) => [newComment, ...prev]);
        setCommentsRender((prev) => [newComment, ...prev]);

        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        setNewCommentText('');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
      } else {
        const error = await response.json();
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmitComment();
    }
  };
  return (
    <section className={styles['comics-page']}>
      <div
        style={{
          padding: 0,
        }}
        className={cn(styles['comics-page__container'], 'container')}
      >
        <SliderPreview mixClass={[styles['comics-page__slider']]} items={covers} backgroundImage={banner} />
        <div className={styles['comics-page__text-container']}>
          <h2 className={styles['comics-page__header']}>{title} </h2>
          <p className={styles['comics-page__author']}> {author} </p>
          <div className={styles['comics-page__details']}>
            <p className={styles['comics-page__age']}> {rating[0].text} </p>
            <p className={styles['comics-page__year']}> {new Date().getFullYear()} </p>
            <p className={styles['comics-page__status']}> {status} </p>
          </div>
          <div className={styles['comics-page__stats']}>
            <p className={styles['comics-page__views']}>
              <svg
                className={cn(theme === 'dark' && styles['svg--dark'])}
                xmlns="http://www.w3.org/2000/svg"
                width="12"
                height="8"
                viewBox="0 0 12 8"
                fill="none"
              >
                <mask id="path-1-inside-1_781_4146" fill="white">
                  <path d="M5.71428 0C8.8702 0 11.4286 2.6613 11.4286 4C11.4286 5.3387 8.8702 8 5.71428 8C2.55837 8 0 5.3387 0 4C0 2.6613 2.55837 0 5.71428 0ZM5.71428 0.666667C4.44699 0.666667 3.17445 1.17002 2.14027 2.00276C1.27048 2.70314 0.714285 3.54514 0.714285 4C0.714285 4.45486 1.27048 5.29686 2.14027 5.99724C3.17445 6.82998 4.44699 7.33333 5.71428 7.33333C6.98158 7.33333 8.25412 6.82998 9.2883 5.99724C10.1581 5.29686 10.7143 4.45486 10.7143 4C10.7143 3.54514 10.1581 2.70314 9.2883 2.00276C8.25412 1.17002 6.98158 0.666667 5.71428 0.666667ZM5.71428 2C6.89775 2 7.85714 2.89543 7.85714 4C7.85714 5.10457 6.89775 6 5.71428 6C4.53082 6 3.57143 5.10457 3.57143 4C3.57143 2.89543 4.53082 2 5.71428 2ZM5.71428 2.66667C4.92531 2.66667 4.28571 3.26362 4.28571 4C4.28571 4.73638 4.92531 5.33333 5.71428 5.33333C6.50326 5.33333 7.14286 4.73638 7.14286 4C7.14286 3.26362 6.50326 2.66667 5.71428 2.66667Z" />
                </mask>
                <path
                  d="M2.14027 2.00276L4.64895 5.11829L2.14027 2.00276ZM2.14027 5.99724L4.64895 2.88171L2.14027 5.99724ZM9.2883 5.99724L6.77962 2.88171H6.77962L9.2883 5.99724ZM9.2883 2.00276L6.77962 5.11829H6.77962L9.2883 2.00276ZM5.71428 4C6.17783 4 6.74806 4.21239 7.24621 4.61352C7.48399 4.80498 7.60857 4.9644 7.64192 5.01489C7.6571 5.03787 7.62024 4.98844 7.57199 4.8611C7.52916 4.74806 7.42857 4.44605 7.42857 4H15.4286C15.4286 2.53594 14.7974 1.33273 14.3171 0.60558C13.7721 -0.219426 13.0599 -0.976339 12.2636 -1.61754C10.6936 -2.88174 8.40665 -4 5.71428 -4V4ZM7.42857 4C7.42857 3.55395 7.52916 3.25194 7.57199 3.1389C7.62024 3.01156 7.6571 2.96213 7.64192 2.98511C7.60857 3.0356 7.48399 3.19502 7.24621 3.38648C6.74806 3.78761 6.17783 4 5.71428 4V12C8.40665 12 10.6936 10.8817 12.2636 9.61754C13.0599 8.97634 13.7721 8.21943 14.3171 7.39442C14.7974 6.66727 15.4286 5.46406 15.4286 4H7.42857ZM5.71428 4C5.25074 4 4.68051 3.78761 4.18236 3.38648C3.94458 3.19502 3.82 3.0356 3.78664 2.98511C3.77146 2.96213 3.80832 3.01156 3.85657 3.1389C3.89941 3.25194 4 3.55395 4 4H-4C-4 5.46406 -3.36885 6.66727 -2.88853 7.39442C-2.34357 8.21943 -1.63131 8.97634 -0.835008 9.61754C0.735004 10.8817 3.02192 12 5.71428 12V4ZM4 4C4 4.44605 3.89941 4.74806 3.85657 4.8611C3.80832 4.98844 3.77146 5.03787 3.78664 5.01489C3.82 4.9644 3.94458 4.80498 4.18236 4.61352C4.68051 4.21239 5.25074 4 5.71428 4V-4C3.02192 -4 0.735004 -2.88174 -0.835008 -1.61754C-1.63131 -0.976339 -2.34357 -0.219426 -2.88853 0.60558C-3.36885 1.33273 -4 2.53594 -4 4H4ZM5.71428 -3.33333C3.4044 -3.33333 1.26833 -2.4307 -0.368416 -1.11277L4.64895 5.11829C5.08058 4.77073 5.48959 4.66667 5.71428 4.66667V-3.33333ZM-0.368416 -1.11277C-1.07174 -0.546436 -1.69568 0.111835 -2.1787 0.803709C-2.52891 1.30535 -3.28571 2.48783 -3.28571 4H4.71429C4.71429 4.33977 4.66399 4.60757 4.62144 4.77849C4.57763 4.95452 4.52754 5.08554 4.4931 5.16615C4.45757 5.24929 4.42699 5.30608 4.40982 5.33615C4.39205 5.36728 4.38129 5.38263 4.38091 5.38319C4.3802 5.3842 4.38611 5.3757 4.39983 5.35897C4.41339 5.34244 4.43244 5.32047 4.4572 5.29428C4.50772 5.24084 4.57263 5.17974 4.64895 5.11829L-0.368416 -1.11277ZM-3.28571 4C-3.28571 5.51217 -2.52891 6.69465 -2.1787 7.19629C-1.69568 7.88816 -1.07174 8.54644 -0.368416 9.11276L4.64895 2.88171C4.57263 2.82026 4.50772 2.75916 4.4572 2.70572C4.43244 2.67953 4.41339 2.65756 4.39983 2.64103C4.38611 2.6243 4.3802 2.6158 4.3809 2.61681C4.38129 2.61737 4.39205 2.63272 4.40982 2.66385C4.42699 2.69392 4.45757 2.75071 4.4931 2.83385C4.52754 2.91446 4.57763 3.04548 4.62144 3.22151C4.66399 3.39243 4.71429 3.66023 4.71429 4H-3.28571ZM-0.368416 9.11276C1.26833 10.4307 3.4044 11.3333 5.71428 11.3333V3.33333C5.48959 3.33333 5.08058 3.22927 4.64895 2.88171L-0.368416 9.11276ZM5.71428 11.3333C8.02417 11.3333 10.1602 10.4307 11.797 9.11276L6.77962 2.88171C6.34799 3.22927 5.93898 3.33333 5.71428 3.33333V11.3333ZM11.797 9.11276C12.5003 8.54644 13.1242 7.88816 13.6073 7.19629C13.9575 6.69465 14.7143 5.51217 14.7143 4H6.71428C6.71428 3.66023 6.76458 3.39244 6.80713 3.22151C6.85094 3.04548 6.90103 2.91446 6.93547 2.83385C6.971 2.75071 7.00158 2.69392 7.01875 2.66385C7.03652 2.63272 7.04728 2.61737 7.04766 2.61681C7.04837 2.6158 7.04246 2.6243 7.02874 2.64103C7.01518 2.65756 6.99613 2.67953 6.97137 2.70572C6.92085 2.75916 6.85593 2.82026 6.77962 2.88171L11.797 9.11276ZM14.7143 4C14.7143 2.48783 13.9575 1.30535 13.6073 0.803709C13.1242 0.111836 12.5003 -0.546436 11.797 -1.11277L6.77962 5.11829C6.85593 5.17974 6.92085 5.24084 6.97137 5.29428C6.99613 5.32047 7.01518 5.34244 7.02874 5.35897C7.04246 5.3757 7.04837 5.3842 7.04766 5.38319C7.04728 5.38263 7.03652 5.36728 7.01875 5.33615C7.00158 5.30608 6.971 5.24929 6.93547 5.16615C6.90103 5.08554 6.85094 4.95451 6.80713 4.77849C6.76458 4.60756 6.71428 4.33977 6.71428 4H14.7143ZM11.797 -1.11277C10.1602 -2.4307 8.02417 -3.33333 5.71428 -3.33333V4.66667C5.93898 4.66667 6.34799 4.77073 6.77962 5.11829L11.797 -1.11277ZM5.71428 6C4.95302 6 3.85714 5.36002 3.85714 4H11.8571C11.8571 0.430842 8.84248 -2 5.71428 -2V6ZM3.85714 4C3.85714 2.63998 4.95302 2 5.71428 2V10C8.84248 10 11.8571 7.56916 11.8571 4H3.85714ZM5.71428 2C6.47555 2 7.57143 2.63998 7.57143 4H-0.428572C-0.428572 7.56916 2.58609 10 5.71428 10V2ZM7.57143 4C7.57143 5.36002 6.47555 6 5.71428 6V-2C2.58609 -2 -0.428572 0.430842 -0.428572 4H7.57143ZM5.71428 -1.33333C2.98058 -1.33333 0.285713 0.799032 0.285713 4H8.28571C8.28571 5.72821 6.87004 6.66667 5.71428 6.66667V-1.33333ZM0.285713 4C0.285713 7.20097 2.98058 9.33333 5.71428 9.33333V1.33333C6.87003 1.33333 8.28571 2.27179 8.28571 4H0.285713ZM5.71428 9.33333C8.44799 9.33333 11.1429 7.20097 11.1429 4H3.14286C3.14286 2.27179 4.55853 1.33333 5.71428 1.33333V9.33333ZM11.1429 4C11.1429 0.799032 8.44799 -1.33333 5.71428 -1.33333V6.66667C4.55853 6.66667 3.14286 5.72821 3.14286 4H11.1429Z"
                  fill="#2D283E"
                  mask="url(#path-1-inside-1_781_4146)"
                />
              </svg>
              {comicsStats.views.toLocaleString()}
            </p>
            <p className={styles['comics-page__likes']}>
              <svg
                className={cn(theme === 'dark' && styles['svg--dark'])}
                xmlns="http://www.w3.org/2000/svg"
                width="12"
                height="10"
                viewBox="0 0 12 10"
                fill="none"
              >
                <path
                  d="M5.44761 1.77695L5.92871 2.64532L6.40981 1.77695C6.61274 1.41067 6.90886 1.1043 7.26832 0.888831C7.62317 0.676131 8.02732 0.559468 8.44092 0.550239C9.11226 0.583633 9.74383 0.878902 10.1996 1.37273L10.6038 0.99972L10.1996 1.37273C10.659 1.87053 10.9024 2.52963 10.8769 3.20602L10.8765 3.21639V3.22678C10.8765 4.08618 10.4161 5.05499 9.66281 6.04353C8.91945 7.01901 7.94562 7.94276 7.04153 8.70038L7.04115 8.7007C6.72966 8.9622 6.33575 9.10562 5.92871 9.10562C5.52168 9.10562 5.12776 8.9622 4.81627 8.7007L4.81589 8.70038C3.9118 7.94276 2.93797 7.01901 2.19461 6.04353C1.44131 5.05499 0.980929 4.08618 0.980929 3.22678V3.21639L0.980537 3.20602C0.954989 2.52963 1.19843 1.87053 1.65784 1.37273C2.1136 0.878902 2.74516 0.583633 3.4165 0.550239C3.83011 0.559468 4.23425 0.676131 4.5891 0.888831C4.94856 1.1043 5.24468 1.41067 5.44761 1.77695Z"
                  stroke="#2D283E"
                  strokeWidth="1.1"
                />
              </svg>
              {comicsStats.likes.toLocaleString()}
            </p>

            <p className={styles['comics-page__bookmarks']}>
              <svg
                className={cn(theme === 'dark' && styles['svg--dark'])}
                xmlns="http://www.w3.org/2000/svg"
                width="9"
                height="9"
                viewBox="0 0 9 9"
                fill="none"
              >
                <path
                  d="M7.21289 0.55H1.52885C1.51172 0.55 1.49817 0.552892 1.48356 0.559144L1.47614 0.562323L1.46862 0.565282C1.43469 0.578639 1.41913 0.593192 1.40629 0.611625L7.21289 0.55ZM7.21289 0.55V0.550083H7.76289C7.78016 0.550083 7.79377 0.553013 7.80824 0.559208L7.81557 0.562344L7.82298 0.565266C7.85712 0.578724 7.87269 0.593295 7.8854 0.61148C7.89894 0.63095 7.90288 0.644367 7.90288 0.666211V0.666295V8.33377C7.90288 8.35591 7.89888 8.36915 7.8856 8.38823L7.88549 8.38838C7.87265 8.40684 7.85712 8.42139 7.82317 8.43476L7.82311 8.43461L7.81205 8.43927C7.80966 8.44001 7.79515 8.444 7.76287 8.444C7.71012 8.444 7.67859 8.43165 7.64392 8.40115L5.0271 5.88502L4.6459 5.51849L4.26469 5.88502L1.64731 8.40162C1.60337 8.44072 1.57059 8.45 1.52885 8.45C1.51145 8.45 1.49791 8.44704 1.48374 8.44097L1.47619 8.43774L1.46855 8.43473C1.43477 8.42144 1.41922 8.40697 1.40642 8.38867C1.39278 8.36905 1.38887 8.35565 1.38887 8.33379V0.666211C1.38887 0.644351 1.3928 0.631013 1.40625 0.611682L7.21289 0.55Z"
                  stroke="#2D283E"
                  strokeWidth="1.1"
                />
              </svg>
              {comicsStats.bookmarks.toLocaleString()}
            </p>
          </div>
          <div className={styles['buttons']}>
            <button onClick={handleOpenBookmarks} className={styles['buttons__bookmark']}>
              –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
            </button>
            <button onClick={() => router.push(`/comics/${id}`)} className={styles['buttons__read']}>
              –ß–∏—Ç–∞—Ç—å
            </button>
          </div>
          <div className="container">
            <Tabs mixClass={[]} tabs={['–û–ø–∏—Å–∞–Ω–∏–µ', '–ì–ª–∞–≤—ã', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏']}>
              <div className={styles['comics-page__description-container']}>
                <p
                  onKeyDown={(e) => (e.key === 'Enter' ? setIsVisibleMore(true) : false)}
                  onClick={() => setIsVisibleMore((prev) => !prev)}
                  className={cn(styles['comics-page__description'], {
                    [styles['comics-page__description--open']]: isVisibleMore,
                  })}
                >
                  {description}
                </p>
                <button onClick={() => setIsVisibleMore((prev) => !prev)} className={styles['comics-page__show-more']}>
                  –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                  <svg
                    className={cn({
                      [styles['comics-page__arrow--active']]: isVisibleMore,
                    })}
                    xmlns="http://www.w3.org/2000/svg"
                    width="6"
                    height="4"
                    viewBox="0 0 6 4"
                    fill="none"
                  >
                    <path
                      d="M3 4C3.36777 4.0005 3.72293 3.82325 3.99829 3.5018C4.16258 3.30901 4.31833 3.12152 4.42032 2.98703L5.86375 1.11612C5.95259 0.991442 6.0014 0.826281 5.99997 0.655217C5.99854 0.484153 5.94699 0.320448 5.8561 0.198373C5.76521 0.076297 5.64203 0.00531507 5.51235 0.000286341C5.38268 -0.00474215 5.25655 0.0565724 5.16038 0.171394L3.71343 2.04562C3.61897 2.1695 3.4783 2.33778 3.3321 2.50937C3.24031 2.61612 3.12213 2.67503 2.99975 2.67503C2.87736 2.67503 2.75919 2.61612 2.6674 2.50937C2.5217 2.33844 2.38103 2.17017 2.28959 2.05025L0.839623 0.171394C0.743452 0.0565724 0.617324 -0.00474215 0.487645 0.000286341C0.357965 0.00531507 0.234789 0.076297 0.1439 0.198373C0.0530114 0.320448 0.00145721 0.484153 3.05176e-05 0.655217C-0.00139666 0.826281 0.0474143 0.991442 0.136245 1.11612L1.58219 2.99034C1.68267 3.12284 1.83691 3.30835 2.0007 3.49981C2.27603 3.82245 2.63166 4.00046 3 4Z"
                      fill="#7A5AF8"
                    />
                  </svg>
                </button>
                <div className={styles['filters']}>
                  <header className={styles['filters__header']}>–ñ–∞–Ω—Ä—ã</header>
                  <div className={styles['filters__container']}>
                    {genres.slice(0, 10).map((genre) => {
                      const text = (isBackend ? reverseMap[genre as unknown as string] : genre?.text) as string;
                      return (
                        <label key={text} htmlFor={`id${text}`} className={styles['filters__label']}>
                          {text} <input id={`id${text}`} type="checkbox" className="myvisuallyhidden" />
                        </label>
                      );
                    })}
                  </div>
                </div>
                <div className={styles['same']}>
                  <header className={styles['same__header']}>
                    <p className={styles['same__text']}>–ü–æ—Ö–æ–∂–µ–µ</p>
                  </header>
                  <SimilarComics id={id} />
                </div>
              </div>
              <div className={cn(styles['comics-page__chapters'], 'chapters')}>
                <button className={styles['chapters__sort-btn']}>
                  <svg xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 9 9" fill="none">
                    <path
                      d="M7.26011 0.144185C7.26106 0.144977 7.26209 0.14563 7.26305 0.146443L8.82836 1.47978C8.93832 1.57357 9.00005 1.70071 9 1.83326C8.99995 1.96581 8.9381 2.09292 8.82807 2.18664C8.71804 2.28037 8.56882 2.33304 8.41321 2.33309C8.2576 2.33314 8.10833 2.28055 7.99822 2.18689L7.43497 1.70711L7.43497 8.5C7.43497 8.63261 7.37312 8.75979 7.26304 8.85355C7.15296 8.94732 7.00366 9 6.84798 9C6.69229 9 6.54299 8.94732 6.43291 8.85355C6.32283 8.75979 6.26098 8.63261 6.26098 8.5L6.26098 1.70711L5.69773 2.18689C5.58762 2.28055 5.43835 2.33314 5.28274 2.33309C5.12713 2.33304 4.97791 2.28037 4.86788 2.18664C4.75785 2.09292 4.696 1.96581 4.69595 1.83326C4.6959 1.70071 4.75763 1.57357 4.86759 1.47978L6.4329 0.146443C6.43386 0.14563 6.43489 0.144979 6.43584 0.144185C6.44862 0.133423 6.46192 0.123108 6.47583 0.113382C6.48304 0.108337 6.49063 0.103943 6.49804 0.0992432C6.50597 0.0942173 6.51368 0.0889893 6.52192 0.0842896C6.53064 0.0793247 6.53967 0.0749912 6.54865 0.0704556C6.55613 0.0666714 6.56344 0.0626431 6.57115 0.0591221C6.5802 0.0550127 6.5895 0.0514927 6.59876 0.0478106C6.60688 0.0445356 6.61488 0.0410767 6.62322 0.038126C6.63223 0.0349522 6.6414 0.0323887 6.65052 0.0296221C6.65948 0.0268955 6.66829 0.0239668 6.67741 0.0216064C6.68663 0.0192261 6.69602 0.0174761 6.70534 0.0155029C6.71458 0.0135298 6.7237 0.0113115 6.73314 0.00970459C6.74393 0.00787354 6.75485 0.0067749 6.76574 0.00547218C6.77381 0.00449562 6.78177 0.00317383 6.78994 0.00250244C6.82854 -0.000753403 6.86742 -0.000753403 6.90602 0.00250244C6.91418 0.00317383 6.92214 0.00449562 6.93021 0.00547218C6.9411 0.0067749 6.95202 0.00787354 6.96281 0.00970459C6.97225 0.0113115 6.98137 0.0135298 6.99062 0.0155029C6.99993 0.0174761 7.00932 0.0192261 7.01854 0.0216064C7.02766 0.0239668 7.03647 0.0268974 7.04543 0.0296221C7.05455 0.0323887 7.06373 0.0349522 7.07273 0.038126C7.08107 0.0410767 7.08907 0.0445356 7.09719 0.0478106C7.10646 0.0514927 7.11575 0.0550127 7.1248 0.0591221C7.13251 0.0626421 7.13982 0.0666704 7.1473 0.0704556C7.15628 0.0749922 7.16531 0.0793266 7.17403 0.0842896C7.18227 0.0889893 7.18998 0.0942173 7.19791 0.0992432C7.20532 0.103943 7.21291 0.108337 7.22013 0.113382C7.23403 0.123108 7.24733 0.133423 7.26011 0.144185ZM1.80209 8.90076C1.81002 8.90578 1.81773 8.91101 1.82597 8.91571C1.83469 8.92067 1.84372 8.92501 1.8527 8.92954C1.86018 8.93333 1.86748 8.93736 1.8752 8.94088C1.88428 8.94501 1.89362 8.94853 1.90291 8.95223C1.911 8.95548 1.91896 8.95892 1.92725 8.96185C1.93628 8.96505 1.94549 8.96763 1.95467 8.9704C1.96358 8.97312 1.97236 8.97603 1.98146 8.97839C1.99068 8.98077 2.00007 8.98252 2.00939 8.9845C2.01863 8.98647 2.02775 8.98869 2.03719 8.9903C2.04798 8.99213 2.0589 8.99323 2.06979 8.99453C2.07786 8.9955 2.08582 8.99683 2.09399 8.9975C2.13258 9.00075 2.17147 9.00075 2.21006 8.9975C2.21823 8.99683 2.22619 8.9955 2.23426 8.99453C2.24515 8.99323 2.25607 8.99213 2.26686 8.9903C2.2763 8.98869 2.28542 8.98647 2.29467 8.9845C2.30398 8.98252 2.31337 8.98077 2.32259 8.97839C2.33168 8.97603 2.34048 8.97312 2.34939 8.9704C2.35856 8.96763 2.36778 8.96505 2.3768 8.96185C2.38509 8.95892 2.39304 8.95548 2.40114 8.95223C2.41043 8.94852 2.41977 8.94501 2.42885 8.94087C2.43656 8.93736 2.44387 8.93333 2.45135 8.92954C2.46033 8.925 2.46936 8.92067 2.47808 8.91571C2.48632 8.91101 2.49403 8.90578 2.50196 8.90075C2.50937 8.89606 2.51696 8.89166 2.52418 8.88662C2.53808 8.87689 2.55138 8.86657 2.56416 8.85581C2.56511 8.85502 2.56614 8.85437 2.5671 8.85355L4.13241 7.52022C4.24237 7.42643 4.30411 7.29929 4.30405 7.16674C4.304 7.03419 4.24216 6.90708 4.13212 6.81336C4.02209 6.71963 3.87287 6.66695 3.71726 6.66691C3.56165 6.66686 3.41238 6.71945 3.30227 6.81311L2.73902 7.29289L2.73902 0.5C2.73902 0.367392 2.67717 0.240214 2.56709 0.146446C2.45701 0.0526781 2.3077 0 2.15202 0C1.99634 0 1.84704 0.0526781 1.73696 0.146446C1.62687 0.240214 1.56503 0.367392 1.56503 0.5L1.56503 7.29289L1.00178 6.81311C0.891668 6.71945 0.742404 6.66686 0.586793 6.66691C0.431183 6.66696 0.281961 6.71963 0.171928 6.81336C0.0618948 6.90708 5.45784e-05 7.03419 3.61096e-08 7.16674C-5.45062e-05 7.29929 0.061681 7.42643 0.171637 7.52022L1.73695 8.85356C1.73791 8.85437 1.73894 8.85502 1.73989 8.85581C1.75267 8.86658 1.76597 8.87689 1.77987 8.88662C1.78709 8.89166 1.79468 8.89606 1.80209 8.90076Z"
                      fill="#2D283E"
                    />
                  </svg>
                  –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                </button>
                <Chapters
                  chapters={toms
                    .map((el) => el.chapters)
                    .flat()
                    .map((el) => ({ likes: el.likes, timeCode: el.timeCode, title: el.title, isRead: el.isRead }))}
                />
              </div>
              <div className={styles['comics-page__comments']}>
                <button onClick={() => setIsModalOpen(true)} className={styles['comments__sort-btn']}>
                  <svg xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 9 9" fill="none">
                    <path
                      d="M7.26011 0.144185C7.26106 0.144977 7.26209 0.14563 7.26305 0.146443L8.82836 1.47978C8.93832 1.57357 9.00005 1.70071 9 1.83326C8.99995 1.96581 8.9381 2.09292 8.82807 2.18664C8.71804 2.28037 8.56882 2.33304 8.41321 2.33309C8.2576 2.33314 8.10833 2.28055 7.99822 2.18689L7.43497 1.70711L7.43497 8.5C7.43497 8.63261 7.37312 8.75979 7.26304 8.85355C7.15296 8.94732 7.00366 9 6.84798 9C6.69229 9 6.54299 8.94732 6.43291 8.85355C6.32283 8.75979 6.26098 8.63261 6.26098 8.5L6.26098 1.70711L5.69773 2.18689C5.58762 2.28055 5.43835 2.33314 5.28274 2.33309C5.12713 2.33304 4.97791 2.28037 4.86788 2.18664C4.75785 2.09292 4.696 1.96581 4.69595 1.83326C4.6959 1.70071 4.75763 1.57357 4.86759 1.47978L6.4329 0.146443C6.43386 0.14563 6.43489 0.144979 6.43584 0.144185C6.44862 0.133423 6.46192 0.123108 6.47583 0.113382C6.48304 0.108337 6.49063 0.103943 6.49804 0.0992432C6.50597 0.0942173 6.51368 0.0889893 6.52192 0.0842896C6.53064 0.0793247 6.53967 0.0749912 6.54865 0.0704556C6.55613 0.0666714 6.56344 0.0626431 6.57115 0.0591221C6.5802 0.0550127 6.5895 0.0514927 6.59876 0.0478106C6.60688 0.0445356 6.61488 0.0410767 6.62322 0.038126C6.63223 0.0349522 6.6414 0.0323887 6.65052 0.0296221C6.65948 0.0268955 6.66829 0.0239668 6.67741 0.0216064C6.68663 0.0192261 6.69602 0.0174761 6.70534 0.0155029C6.71458 0.0135298 6.7237 0.0113115 6.73314 0.00970459C6.74393 0.00787354 6.75485 0.0067749 6.76574 0.00547218C6.77381 0.00449562 6.78177 0.00317383 6.78994 0.00250244C6.82854 -0.000753403 6.86742 -0.000753403 6.90602 0.00250244C6.91418 0.00317383 6.92214 0.00449562 6.93021 0.00547218C6.9411 0.0067749 6.95202 0.00787354 6.96281 0.00970459C6.97225 0.0113115 6.98137 0.0135298 6.99062 0.0155029C6.99993 0.0174761 7.00932 0.0192261 7.01854 0.0216064C7.02766 0.0239668 7.03647 0.0268974 7.04543 0.0296221C7.05455 0.0323887 7.06373 0.0349522 7.07273 0.038126C7.08107 0.0410767 7.08907 0.0445356 7.09719 0.0478106C7.10646 0.0514927 7.11575 0.0550127 7.1248 0.0591221C7.13251 0.0626421 7.13982 0.0666704 7.1473 0.0704556C7.15628 0.0749922 7.16531 0.0793266 7.17403 0.0842896C7.18227 0.0889893 7.18998 0.0942173 7.19791 0.0992432C7.20532 0.103943 7.21291 0.108337 7.22013 0.113382C7.23403 0.123108 7.24733 0.133423 7.26011 0.144185ZM1.80209 8.90076C1.81002 8.90578 1.81773 8.91101 1.82597 8.91571C1.83469 8.92067 1.84372 8.92501 1.8527 8.92954C1.86018 8.93333 1.86748 8.93736 1.8752 8.94088C1.88428 8.94501 1.89362 8.94853 1.90291 8.95223C1.911 8.95548 1.91896 8.95892 1.92725 8.96185C1.93628 8.96505 1.94549 8.96763 1.95467 8.9704C1.96358 8.97312 1.97236 8.97603 1.98146 8.97839C1.99068 8.98077 2.00007 8.98252 2.00939 8.9845C2.01863 8.98647 2.02775 8.98869 2.03719 8.9903C2.04798 8.99213 2.0589 8.99323 2.06979 8.99453C2.07786 8.9955 2.08582 8.99683 2.09399 8.9975C2.13258 9.00075 2.17147 9.00075 2.21006 8.9975C2.21823 8.99683 2.22619 8.9955 2.23426 8.99453C2.24515 8.99323 2.25607 8.99213 2.26686 8.9903C2.2763 8.98869 2.28542 8.98647 2.29467 8.9845C2.30398 8.98252 2.31337 8.98077 2.32259 8.97839C2.33168 8.97603 2.34048 8.97312 2.34939 8.9704C2.35856 8.96763 2.36778 8.96505 2.3768 8.96185C2.38509 8.95892 2.39304 8.95548 2.40114 8.95223C2.41043 8.94852 2.41977 8.94501 2.42885 8.94087C2.43656 8.93736 2.44387 8.93333 2.45135 8.92954C2.46033 8.925 2.46936 8.92067 2.47808 8.91571C2.48632 8.91101 2.49403 8.90578 2.50196 8.90075C2.50937 8.89606 2.51696 8.89166 2.52418 8.88662C2.53808 8.87689 2.55138 8.86657 2.56416 8.85581C2.56511 8.85502 2.56614 8.85437 2.5671 8.85355L4.13241 7.52022C4.24237 7.42643 4.30411 7.29929 4.30405 7.16674C4.304 7.03419 4.24216 6.90708 4.13212 6.81336C4.02209 6.71963 3.87287 6.66695 3.71726 6.66691C3.56165 6.66686 3.41238 6.71945 3.30227 6.81311L2.73902 7.29289L2.73902 0.5C2.73902 0.367392 2.67717 0.240214 2.56709 0.146446C2.45701 0.0526781 2.3077 0 2.15202 0C1.99634 0 1.84704 0.0526781 1.73696 0.146446C1.62687 0.240214 1.56503 0.367392 1.56503 0.5L1.56503 7.29289L1.00178 6.81311C0.891668 6.71945 0.742404 6.66686 0.586793 6.66691C0.431183 6.66696 0.281961 6.71963 0.171928 6.81336C0.0618948 6.90708 5.45784e-05 7.03419 3.61096e-08 7.16674C-5.45062e-05 7.29929 0.061681 7.42643 0.171637 7.52022L1.73695 8.85356C1.73791 8.85437 1.73894 8.85502 1.73989 8.85581C1.75267 8.86658 1.76597 8.87689 1.77987 8.88662C1.78709 8.89166 1.79468 8.89606 1.80209 8.90076Z"
                      fill="#2D283E"
                    />
                  </svg>
                  –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                  <span className={styles['curr-sort']}>{getSortBy()}</span>
                </button>
                {isModalOpen && (
                  <FilterBarComponent
                    currentSort={sortBy}
                    onSelect={handleSortSelect}
                    onClose={() => setIsModalOpen(false)}
                  />
                )}
                <label className={styles['comments__label']} htmlFor="send-message-btn">
                  <input
                    className={styles['comments__input']}
                    placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                    type="text"
                    id="send-message-btn"
                    value={newCommentText}
                    onChange={(e) => setNewCommentText(e.target.value)}
                    onKeyPress={handleKeyPress}
                    disabled={isSubmitting}
                  />

                  <button
                    className={styles['comments__send']}
                    onClick={handleSubmitComment}
                    disabled={isSubmitting || !newCommentText.trim()}
                  >
                    {isSubmitting ? (
                      <span>...</span> // –∏–ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    ) : (
                      <svg width="24" height="24" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="22" height="22" rx="11" fill="#7A5AF8" />
                        <path
                          d="M11 6L11 16"
                          stroke="white"
                          stroke-width="1.42857"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                        <path
                          d="M16 11L11 6L6 11"
                          stroke="white"
                          stroke-width="1.42857"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                    )}
                  </button>
                </label>
                <p className={styles['comments__counter']}>{comicsComments.length} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
                {commentsRender.map((comment) => (
                  <ComicsComment key={comment.id} comment={comment} />
                ))}
                <button className={styles['buttons__download']}>–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ</button>
              </div>
            </Tabs>
          </div>
        </div>
      </div>
    </section>
  );
};

export default ComicsPreview;
